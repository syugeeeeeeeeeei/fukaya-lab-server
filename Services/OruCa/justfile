# /OruCa/justfile (å†ä¿®æ­£: up/buildã‚¿ã‚¹ã‚¯ã‚’å¾©æ´»ã•ã›ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶å¾¡ã‚’å®Ÿè£…)
_default:
  @just --list -u

# -----------------------------------------------------------------
# Â ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ã‚¿ã‚¹ã‚¯
# -----------------------------------------------------------------
# å¤–éƒ¨ã®justfileã‹ã‚‰ profile å¼•æ•°ã‚’å—ã‘å–ã‚‹
[group("æ±ç”¨ã‚¿ã‚¹ã‚¯")]
[doc("OruCa ã‚µãƒ¼ãƒ“ã‚¹ã«å¿…è¦ãª Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚")]
build profile='dev':
    @echo "==> ğŸ”¨ Building OruCa images (Profile: {{profile}})..."
    @if [[ "{{profile}}" == "prod" ]]; then \
        echo "--> ğŸ—ï¸ Running Production Build (vite -> web)"; \
        echo "    1. Starting vite (dev) for build..."; \
        docker compose --env-file ../../.env --profile dev up -d vite && \
        echo "    2. Executing yarn build..."; \
        docker exec -w /usr/src/app/vite oruca-vite yarn build && \
        echo "    3. Stopping vite container..."; \
        docker compose --env-file ../../.env --profile dev down; \
    else \
        echo "--> ğŸ—ï¸ Running Development Build..."; \
        docker compose --env-file ../../.env --profile {{profile}} build; \
    fi
    @echo "==> âœ… OruCa images built/updated."

[group("æ±ç”¨ã‚¿ã‚¹ã‚¯")]
[doc("OruCa ã® Pod ã‚’èµ·å‹•ã—ã¾ã™ã€‚")]
up profile='dev': build
    @echo "--> ğŸš€ Starting OruCa (Profile: {{profile}})"
    @docker compose --env-file ../../.env --profile {{profile}} up -d


# -----------------------------------------------------------------
# Â å›ºæœ‰ã‚¿ã‚¹ã‚¯
# -----------------------------------------------------------------
[group("å›ºæœ‰ã‚¿ã‚¹ã‚¯")]
[doc("OruCa ã® MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚")]
backup:
    @echo "ğŸ’¾ Saving OruCa MySQL backup..."
    @docker exec --env-file ../../.env oruca-mysql sh -c "mkdir -p /backups/$$(date +%Y%m%d-%H%M%S) && mysqldump -u$$MYSQL_USER -p$$MYSQL_PASSWORD $$MYSQL_DATABASE > /backups/$$(date +%Y%m%d-%H%M%S)/backup.sql"
    @echo "âœ… Backup created in OruCa mysql volume's /backups directory."

[group("å›ºæœ‰ã‚¿ã‚¹ã‚¯")]
[doc("æŒ‡å®šã—ãŸæ—¥æ™‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã€‚")]
restore BACKUP_DATE:
    @echo "ğŸ”„ Restoring OruCa MySQL backup from {{BACKUP_DATE}}..."
    @docker exec --env-file ../../.env -i oruca-mysql sh -c "mysql -u'root' -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < /backups/{{BACKUP_DATE}}/backup.sql"
    @echo "âœ… Restore complete."