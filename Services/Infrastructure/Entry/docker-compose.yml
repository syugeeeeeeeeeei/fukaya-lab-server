services:
  # ğŸ”„ Caddy - Reverse Proxy
  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.9-alpine
    container_name: proxy-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    networks:
      -  fukaya-lab-network
    environment:
      - CADDY_INGRESS_NETWORKS=fukaya-lab-network
    volumes:
      # [å¤‰æ›´] podman.sock ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™
      - /var/run/docker.sock:/var/run/docker.sock 
      - caddy_data:/data

  # ğŸ‘‘ CoreDNS - Primary DNS Resolver
  coredns:
    image: coredns/coredns:latest
    container_name: gatewaydns-coredns
    restart: unless-stopped

    ports:
      # IPã¨ãƒãƒ¼ãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚€
      - "${HOST_IP}:${COREDNS_PORT}:53/tcp"
      - "${HOST_IP}:${COREDNS_PORT}:53/udp"
    networks:
      - fukaya-lab-network
    volumes:
      - ./Corefile:/Corefile
    environment:
      # Corefile å†…ã§ $HOST_IP ã¨ $SSH_IP ã‚’ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹
      - HOST_IP=${HOST_IP}
      - SSH_IP=${SSH_IP}
    depends_on:
      - adguardhome
      - caddy

  # ğŸ›¡ï¸ AdGuard Home - DNS Server
  adguardhome:
    image: adguard/adguardhome:latest
    container_name: maindns-adguardhome
    restart: unless-stopped
    ports: [] # CaddyçµŒç”±ã§ã®ã¿å…¬é–‹ã™ã‚‹ãŸã‚ãƒ›ã‚¹ãƒˆãƒãƒ¼ãƒˆã¯ä¸è¦
    networks:
      fukaya-lab-network:
        ipv4_address: 172.20.0.11 # ğŸ‘ˆ AdGuard Homeã®å›ºå®šIP
    volumes:
      - adguard_work:/opt/adguardhome/work
      - adguard_conf:/opt/adguardhome/conf
    labels:
      caddy: http://dns.fukaya-sus.lab
      caddy.reverse_proxy: "{{upstreams 3000}}"