# /fukaya-lab-server/OruCa/justfile (æ–°è¦ä½œæˆ)

# --- ğŸ› ï¸ OruCa ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¹ã‚¯ ---
# ãƒ«ãƒ¼ãƒˆã® 'build' ãƒ¡ã‚¿ã‚¿ã‚¹ã‚¯ã‹ã‚‰ 'OruCa::build' ã¨ã—ã¦å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
build:
    @echo "ğŸ› ï¸ Building OruCa frontend application..."
    @docker compose -f ../docker-compose.yml \
        --profile dev run --rm oruca-vite yarn build
    @echo "âœ… OruCa Frontend built to ./vite/dist/"


# --- ğŸ“¦ OruCa å›ºæœ‰ã‚¿ã‚¹ã‚¯ ---
# 'just OruCa::usb' ã®ã‚ˆã†ã«å‘¼ã³å‡ºã—ã¾ã™ã€‚

# (WSLç”¨) OruCaã®NFCãƒªãƒ¼ãƒ€ãƒ¼ã‚’WSLã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™
# (OruCa/Makefile ã® 'attach-usb' ã‹ã‚‰ç§»æ¤)
usb:
    @echo "ğŸ”Œ Attaching USB FeliCa Reader to WSL..."
    @powershell.exe -ExecutionPolicy Bypass -File ./usb-wsl-attach.ps1
    @echo "âœ… USB device attached."

# OruCaã®DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã™(ä¾‹: just OruCa::backup)
# OruCaã®DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã™(ä¾‹: just OruCa::backup)
backup:
  @echo "ğŸ’¾ Saving OruCa MySQL backup..."
  @docker compose -f ../docker-compose.yml \
    exec oruca-mysql sh -c "\
     TARGET_DIR=/backups/$(date +%Y%m%d-%H%M%S); \
     mkdir -p \"\${TARGET_DIR}\" && \
     mysqldump --no-tablespaces -u\${MYSQL_USER} -p\${MYSQL_PASSWORD} \${MYSQL_DATABASE} > \"\${TARGET_DIR}/backup.sql\""
  @echo "âœ… Backup created in OruCa mysql volume's /backups directory."

# OruCaã®DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ (ä¾‹: just OruCa::restore YYYYMMDD-HHMMSS)
restore BACKUP_DATE:
    @echo "ğŸ”„ Restoring OruCa MySQL backup from {{BACKUP_DATE}}..."
    @docker compose -f ../docker-compose.yml \
        exec -T oruca-mysql sh -c "mysql -u'root' -p${MYSQL_ROOT_PASSWORD} ${MYSQL_DATABASE} < /backups/{{BACKUP_DATE}}/backup.sql"
    @echo "âœ… Restore complete."