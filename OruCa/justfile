# /OruCa/justfile

_default:
  @just --list -u

[doc("OruCa ã‚µãƒ¼ãƒ“ã‚¹ã«å¿…è¦ãª Podman ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚")]
build:
    @echo "==> ğŸ”¨ Building OruCa images..."
    @podman build -t oruca-vite:latest ./vite
    @podman build -t oruca-web:latest ./web
    @podman build -t oruca-api:latest ./api
    @podman build -t oruca-mysql:latest ./mysql
    @podman build -t oruca-nfc:latest ./nfc
    @echo "==> âœ… OruCa images built."

[doc("OruCa ã® Pod (pod.yml) ã‚’èµ·å‹•ã—ã¾ã™ã€‚")]
up: build
    @echo "--> ğŸš€ Starting OruCa"
    @podman kube play ./pod.yml

[doc("OruCa ã® Pod (pod.yml) ã‚’åœæ­¢ã—ã¾ã™ã€‚")]
down:
    @echo "--> ğŸ›‘ Stopping OruCa"
    @podman kube down ./pod.yml

[doc("OruCa ã® MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚")]
backup:
    @echo "ğŸ’¾ Saving OruCa MySQL backup..."
    @# podman exec ã‚’ä½¿ç”¨ã—ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç’°å¢ƒå¤‰æ•° ($$MYSQL_USER ãªã©) ã‚’å‚ç…§ã—ã¾ã™
    @# $$ ã¯ just ã«ã‚ˆã‚‹å±•é–‹ã‚’é˜²ãã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã® sh ã« $ ã‚’æ¸¡ã™ãŸã‚ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã§ã™
    @# $$(date ...) ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã® sh ã§å®Ÿè¡Œï¼ˆã‚³ãƒãƒ³ãƒ‰ç½®æ›ï¼‰ã•ã‚Œã¾ã™
    @podman exec oruca-mysql sh -c "mkdir -p /backups/$$(date +%Y%m%d-%H%M%S) && mysqldump -u$$MYSQL_USER -p$$MYSQL_PASSWORD $$MYSQL_DATABASE > /backups/$$(date +%Y%m%d-%H%M%S)/backup.sql"
    @echo "âœ… Backup created in OruCa mysql volume's /backups directory."

[doc("æŒ‡å®šã—ãŸæ—¥æ™‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã€‚")]
restore BACKUP_DATE:
    @echo "ğŸ”„ Restoring OruCa MySQL backup from {{BACKUP_DATE}}..."
    @# podman exec -i (interactive) ã‚’ä½¿ç”¨ã—ã¦æ¨™æº–å…¥åŠ›ã‚’ã‚³ãƒ³ãƒ†ãƒŠã® sh ã«æ¸¡ã—ã€mysql ã«æµã—è¾¼ã¿ã¾ã™
    @podman exec -i oruca-mysql sh -c "mysql -u'root' -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < /backups/{{BACKUP_DATE}}/backup.sql"
    @echo "âœ… Restore complete."