# /OruCa/justfile

_default:
  @just --list

# [å®Ÿè¡Œä¾‹] just OruCa::build
build:
    @echo "==> ğŸ”¨ Building OruCa images..."
    @podman build -t oruca-vite:latest ./vite
    @podman build -t oruca-web:latest ./web
    @podman build -t oruca-api:latest ./api
    @podman build -t oruca-mysql:latest ./mysql
    @podman build -t oruca-nfc:latest ./nfc
    @echo "==> âœ… OruCa images built."

# [å®Ÿè¡Œä¾‹] just OruCa::up
# 'build' ã‚¿ã‚¹ã‚¯ã«ä¾å­˜ã•ã›ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤ã—ã¾ã™
# up: build
up:
    @echo "--> ğŸš€ Starting OruCa"
    @podman kube play ./pod.yml

# [å®Ÿè¡Œä¾‹] just OruCa::down
down:
    @echo "--> ğŸ›‘ Stopping OruCa"
    @podman kube down ./pod.yml

# [å®Ÿè¡Œä¾‹] just OruCa::backup
# OruCaã®DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã™
backup:
    @echo "ğŸ’¾ Saving OruCa MySQL backup..."
    @# podman exec ã‚’ä½¿ç”¨ã—ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç’°å¢ƒå¤‰æ•° ($$MYSQL_USER ãªã©) ã‚’å‚ç…§ã—ã¾ã™
    @# $$ ã¯ just ã«ã‚ˆã‚‹å±•é–‹ã‚’é˜²ãã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã® sh ã« $ ã‚’æ¸¡ã™ãŸã‚ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã§ã™
    @# $$(date ...) ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã® sh ã§å®Ÿè¡Œï¼ˆã‚³ãƒãƒ³ãƒ‰ç½®æ›ï¼‰ã•ã‚Œã¾ã™
    @podman exec oruca-mysql sh -c "mkdir -p /backups/$$(date +%Y%m%d-%H%M%S) && mysqldump -u$$MYSQL_USER -p$$MYSQL_PASSWORD $$MYSQL_DATABASE > /backups/$$(date +%Y%m%d-%H%M%S)/backup.sql"
    @echo "âœ… Backup created in OruCa mysql volume's /backups directory."

# [å®Ÿè¡Œä¾‹] just OruCa::restore YYYYMMDD-HHMMSS
# OruCaã®DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™
restore BACKUP_DATE:
    @echo "ğŸ”„ Restoring OruCa MySQL backup from {{BACKUP_DATE}}..."
    @# podman exec -i (interactive) ã‚’ä½¿ç”¨ã—ã¦æ¨™æº–å…¥åŠ›ã‚’ã‚³ãƒ³ãƒ†ãƒŠã® sh ã«æ¸¡ã—ã€mysql ã«æµã—è¾¼ã¿ã¾ã™
    @podman exec -i oruca-mysql sh -c "mysql -u'root' -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < /backups/{{BACKUP_DATE}}/backup.sql"
    @echo "âœ… Restore complete."